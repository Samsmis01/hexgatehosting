version: 1

services:
  # Service API (server.js + bot int√©gr√©)
  - type: web
    name: momo-zen
    env: node
    region: frankfurt  # ou singapore, ohio, oregon
    plan: free
    rootDir: .  # IMPORTANT: Indique le dossier racine
    
    # Commande de build
    buildCommand: |
      echo "üîß Installation des d√©pendances..."
      npm install
      echo "üìÅ Cr√©ation des dossiers..."
      mkdir -p public commands viewOnce deleted_messages deleted_images .VV auth_info_baileys
      echo "‚úÖ Build termin√©"
    
    # Commande de d√©marrage UNIQUE (bot + serveur)
    startCommand: |
      echo "üöÄ D√©marrage de MOMO-ZEN..."
      echo "1. D√©marrage du bot WhatsApp en arri√®re-plan..."
      node index.js &
      BOT_PID=$!
      echo "‚úÖ Bot d√©marr√© (PID: $BOT_PID)"
      
      echo "2. Attente de 10 secondes pour la connexion WhatsApp..."
      sleep 10
      
      echo "3. D√©marrage du serveur API..."
      node server.js
      # Note: Le serveur API d√©marre en premier plan
    
    # Port que Render doit surveiller
    envVars:
      - key: PORT
        value: 3000
      - key: NODE_ENV
        value: production
      - key: BOT_PUBLIC
        value: true
      - key: RENDER
        value: "true"
      - key: DISABLE_QR_TERMINAL
        value: "true"  # D√©sactive le QR code dans Render
    
    # Configuration du port (CRITIQUE)
    port: 3000
    
    # Health check (essentiel pour Render)
    healthCheckPath: /health
    initialDelaySec: 45  # Temps pour que le bot se connecte
    
    # Auto-deploy
    autoDeploy: true
    
    # Disque persistant
    disk:
      name: data
      mountPath: /opt/render/project/src/data
      sizeGB: 1
    
    # Headers de s√©curit√©
    headers:
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block
      - path: /*
        name: Content-Security-Policy
        value: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
    
    # Domaine personnalis√© (optionnel)
    # domains:
    #   - momo-zen.onrender.com
    #   - votre-domaine.com

# Scripts de d√©ploiement
preDeployCommands:
  - echo "üîÑ Pr√©paration du d√©ploiement Render..."
  - echo "Node: $(node --version)"
  - echo "NPM: $(npm --version)"

postDeployCommands:
  - echo "‚úÖ D√©ploiement termin√©!"
  - echo "üåê Votre application est disponible sur: https://${RENDER_SERVICE_NAME}.onrender.com"
  - echo "üè• Health check: https://${RENDER_SERVICE_NAME}.onrender.com/health"
  - echo "üì± Interface: https://${RENDER_SERVICE_NAME}.onrender.com"
